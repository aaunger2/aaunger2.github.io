<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://cdn.jsdelivr.net/npm/d3-svg-annotation@2"></script>

<style> circle {fill: red; stroke: black;} </style>

<div style="display:block; width:600;">
<div id= "navigation_buttons" style="display: inline-flex; width: 100%; height:30; justify-content: space-between; padding-bottom: 2;">
<button onclick="document.location='./scene4.html'">Go Back</button>
<h2>Factors Affecting Fuel Efficiency</h2>
<button onclick="document.location='https://aaunger2.github.io/'">Return to Beginning</button>
</div>
</div>

<body onload='init()'>

<div id="div_template"></div>

<script>

async function init() {

const data = await d3.csv('https://flunky.github.io/cars2017.csv');

var canvas_width = 600;
var canvas_height = 600;
var margin = 50;
var svg_height = canvas_height - (2*margin);
var svg_width = canvas_width - (2*margin);
var svg_height_margin = margin + svg_height;
var svg_width_margin = margin + svg_width;

xScale = d3.scaleLog().domain([10,150]).range([0, svg_width]).base(10);
yScale = d3.scaleLog().domain([10,150]).range([svg_height, 0]).base(10);

// append the svg to the body
var svg = d3.select('#div_template')
   .append('svg')
   .attr("width", canvas_width)
   .attr("height", canvas_height);

const categories = ["Gasoline", "Diesel", "Electricity"];
const customColors = ["blue", "red", "green"];
const  legend_fuel = [
    {name: "Electric", color: "green"},
    {name: "Gas", color: "blue"},
    {name: "Diesel"}
];

const colorScale = d3.scaleOrdinal()
    .domain(categories)
    .range(customColors);


//Tooltip modified from https://d3-graph-gallery.com/graph/interactivity_tooltip.html
// create a tooltip
  var Tooltip = d3.select("#div_template")
    .append("div")
    .style("opacity", 0)
    .attr("class", "tooltip")
    .style("background-color", "white")
    .style("border", "solid")
    .style("border-width", "2px")
    .style("border-radius", "5px")
    .style("padding", "5px")

// Three functions change the tooltip when user hover / move / leave a cell
  var mouseover = function(d) {
    Tooltip
      .style("opacity", 1)
    d3.select(this)
      .style("stroke", "black")
      .style("opacity", 1)
  }
  var mousemove = function(d) {
    Tooltip
      .html("Make: " + d.Make + "<br>EngineCylinders: " + d.EngineCylinders + "<br>HWY MPG: " + d.AverageHighwayMPG + "<br>City MPG: " + d.AverageCityMPG)
      .style("left", (d3.mouse(this)[0]+70) + "px")
      .style("top", (d3.mouse(this)[1]) + "px")
  }
  var mouseleave = function(d) {
    Tooltip
      .style("opacity", 0)
    d3.select(this)
      .style("stroke", "black")
      .style("opacity", 0.5)
  }


// y axis
var y_axis = d3.select('svg')
  .append("g")
  .attr("transform", "translate(" + margin + "," + margin + ")")
  .call(d3.axisLeft(yScale)
                     .tickValues([10, 20, 50 ,100])
                     .tickFormat(d3.format("~s")));

// x axis
var x_axis = d3.select('svg')
  .append("g")
  .attr("transform", "translate(" + margin + "," + svg_height_margin + ")")
  .call(d3.axisBottom(xScale)
                     .tickValues([10, 20, 50 ,100])
                     .tickFormat(d3.format("~s")));
// modified from https://d3-graph-gallery.com/graph/interactivity_zoom.html

// Set the zoom and Pan features: how much you can zoom, on which part, and what to do when there is a zoom
var zoom = d3.zoom()
    .scaleExtent([.5, 20])  // This control how much you can unzoom (x0.5) and zoom (x20)
    .extent([[0, 0], [svg_width, svg_height]])
    .on("zoom", updateChart);

// This add an invisible rect on top of the chart area. This rect can recover pointer events: necessary to understand when the user zoom
svg.append("rect")
    .attr("width", svg_width)
    .attr("height", svg_height)
    .style("fill", "none")
    .style("pointer-events", "all")
    .attr('transform', 'translate(' + margin + ',' + margin + ')')
    .call(zoom);

//add circles
svg.append('g')
   .attr("transform","translate(" + margin + "," + margin + ")")
   .selectAll('circle')
   .data(data) 
   .enter()
   .append('circle')
   .attr("cx", function(d,i) {return xScale(d.AverageCityMPG);})
   .attr("cy", function(d,i) {return yScale(d.AverageHighwayMPG);})
   .attr("r",  function(d,i) {return parseInt(d.EngineCylinders) + 5;})
   .attr("opacity", 0.5)
   .style("fill", d => colorScale(d.Fuel))
   .on("mouseover", mouseover)
   .on("mousemove", mousemove)
   .on("mouseleave", mouseleave);




function updateChart() {

    // recover the new scale
    var newX = d3.event.transform.rescaleX(xScale);
    var newY = d3.event.transform.rescaleY(yScale);

    // update axes with these new boundaries -- this is working so above must be working
    x_axis.call(d3.axisBottom(newX).tickFormat(d3.format("~s")));
    y_axis.call(d3.axisLeft(newY).tickFormat(d3.format("~s")));
	
    //console.log(scatter.selectAll('circle'))
    // update circle position
    svg
      .selectAll("circle")
      .attr('cx', function(d) {return newX(d.AverageCityMPG);})
      .attr('cy', function(d) {return newY(d.AverageHighwayMPG);})
      .attr("opacity", 0.5)
      .style("fill", d => colorScale(d.Fuel))
      .on("mouseover", mouseover)
      .on("mousemove", mousemove)
      .on("mouseleave", mouseleave);
	
  }



//add colors for the legend
lineItemHeight = 20

var leg_y = svg_height * 1/2 ;

d3.select('svg')
  .append("g")
  .attr("transform", "translate(" + svg_width_margin + "," +  leg_y + ")")
  .selectAll('rect')
  .data([0,1,2]) 
  .enter()
  .append('rect')
  .attr('fill', (d, i) => customColors[i])
  .attr('stroke', '#000')
  .attr('width', 12)
  .attr('height', 12)
  .attr('x', 0)
  .attr('y', (d, i) => lineItemHeight * (i + 1));

d3.select('svg')
  .append('g') 
  .attr("transform", "translate(" + svg_width_margin + "," + leg_y + ")")
  .selectAll('text')
  .data(categories)
  .enter()
  .append('text')
  .text(d => d)
  .attr('x', 13)
  .attr('y', (d,i) => 10 + lineItemHeight * (i + 1))
  .style('font-size', '9px');

//title
//d3.select('svg')
//   .append("g")
//   .append('text')
//   .text("Factors Affecting Fuel Efficiency")
//   .attr('x', 125)
//   .attr('y', (margin/2))
//   .style('font-size', '25px');
//;


//axis labels
d3.select('svg')
   .append("g")
   .append('text')
   .text("City mpg")
   .attr('x', canvas_width/2- 20)
   .attr('y', canvas_height - (margin/2));

var y_lab_y = canvas_height/2+ 20;
var y_lab_x = 20;

d3.select('svg')
   .append('g')
   .append('text')
   .text("Hwy mpg")
   .attr("x", y_lab_x)
   .attr("y", y_lab_y)
   .attr('transform', 'rotate(-90 ' + y_lab_x + ' ' + y_lab_y + ')')
;
   
const annotations = [
  {
    note: { label: "Move your mouse over the dots to look at individual car data displayed under the graph." },
    x: 60,
    y: 50,
  },
];

const type = d3.annotationLabel
//const type = d3.annotationCalloutCircle

const makeAnnotations = d3.annotation()
          .annotations(annotations)

        d3.select("svg")
          .append("g")
          .attr("class", "annotation-group")
          .call(makeAnnotations)
}


</script>
</body>
</html>
